---
- name: Build Jenkins server
  hosts: localhost
  gather_facts: no
  connection: local
  tasks:
  - name: Install modules
    pip:
      name: "{{ item }}"
      state: present
    with_items:
    - docker-py

- name: Clear a running instance and old images
  include: jenkins-teardown.yml

- name: Build Jenkins server
  hosts: localhost
  gather_facts: no
  connection: local
  tasks:
  - name: Build Jenkins image
    docker_image:
      name: "{{ container_name }}"
      state: present
      path: ./docker

  - name: Create a data container
    docker_container:
      name: "{{ container_name }}"
      image: "{{ image_name | default(container_name) }}"
      recreate: yes
      restart: yes
      force_kill: yes
      ports:
      - "8080:8080"

  - name: Wait for Jenkins to startup
    wait_for:
      timeout: 15

- name: Retrieve initial admin password
  include: jenkins-initial-admin-password.yml
