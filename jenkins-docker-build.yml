---
- name: Build Jenkins server
  hosts: localhost
  gather_facts: no
  connection: local
  tasks:
  - name: Install modules
    pip:
      name: "{{ item }}"
      state: present
    with_items:
    - docker-py

  - name: Obtain ssh credentials
    fetch:
      src: ~/.ssh/{{ item }}
      dest: docker/ssh/{{ item }}
      flat: yes
    with_items:
    - id_rsa
    - id_rsa.pub
    - known_hosts

- name: Clear a running instance and old images
  include: jenkins-docker-teardown.yml


- name: Build Jenkins Container
  hosts: localhost
  gather_facts: no
  connection: local
  vars:
    download_node: https://nodejs.org/dist/
    node_version: v6.10.2
    node_package_name: "node-{{ node_version }}-linux-x64"
    node_archive: "{{ node_package_name }}.tar.xz"
  tasks:
  - name: Download node
    become: no
    get_url:
      url: "{{ download_node }}/{{ node_version }}/{{ node_archive }}"
      dest: "docker/{{ node_archive }}"

  - name: Build Jenkins Image
    docker_image:
      name: "{{ container_name }}"
      state: present
      rm: true
      path: ./docker

  - name: Run Jenkins Container
    docker_container:
      name: "{{ container_name }}"
      image: "{{ image_name | default(container_name) }}"
      recreate: yes
      restart: yes
      force_kill: yes
      ports:
      - "8080:8080"
      env:
        GIT_NAME: "{{ git_name }}"
        GIT_EMAIL: "{{ git_email }}"
        GIT_PASSWORD: "{{ git_password }}"

  - name: Wait for Jenkins to startup
    wait_for:
      timeout: 30

- name: Retrieve initial admin password
  include: jenkins-docker-initial-password.yml
